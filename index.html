// ================== ANNOUNCEMENT ==================
const ANNOUNCEMENT_TEXT = "ðŸ”¥If you have any ideas for this website, go to the feedback menu and let me know. Also, hatch the Blossom egg, limited 1/500k secret pet being removed soon.";
document.getElementById('announcementBox').textContent = ANNOUNCEMENT_TEXT;

// ================== LIGHT/DARK TOGGLE ==================
document.getElementById('toggleTheme').onclick = () => document.body.classList.toggle('light');

// ================== TABS ==================
document.querySelectorAll('.tab').forEach(tab=>{
  tab.onclick = ()=>{
    document.querySelectorAll('.tab,.section').forEach(e=>e.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(tab.dataset.tab).classList.add('active');
  };
});

// ================== HELPER ==================
function parseRarity(input){
  if(!input) return null;
  input=input.toLowerCase().replace(/,/g,'').trim();

  // Handle "x x x" multipliers
  if(input.includes(' ')){
    let parts=input.split(' ').map(Number);
    if(parts.length===3) return Math.round(25000/parts[0]*parts[1]*parts[2]);
  }

  if(input.endsWith('%')) return Math.round(1/(Number(input.replace('%',''))/100));
  if(input.includes('/')){
    let denom = input.split('/')[1];
    if(denom.endsWith('k')) return Number(denom.replace('k',''))*1000;
    if(denom.endsWith('m')) return Number(denom.replace('m',''))*1_000_000;
    return Number(denom);
  }
  if(input.endsWith('k')) return Number(input.replace('k',''))*1000;
  if(input.endsWith('m')) return Number(input.replace('m',''))*1_000_000;
  let val=Number(input);
  if(val>0 && val<1) return Math.round(1/val);
  return val;
}

// ================== POPULATE SELECTS ==================
[document.getElementById('eggSelect'),document.getElementById('simEggSelect')].forEach(sel=>{
  Object.keys(eggsData).forEach(e=>{
    let o=document.createElement('option'); o.value=o.textContent=e; sel.appendChild(o);
  });
});

// ================== SINGLE CALCULATOR ==================
document.getElementById('calcBtn').onclick = () => {
  const base = parseRarity(document.getElementById('baseRarity').value);
  const yourLuck = Number(document.getElementById('yourLuck').value)||1;
  const eventLuck = Number(document.getElementById('eventLuck').value)||1;
  const adminLuck = Number(document.getElementById('adminLuck').value)||1;
  const eggs = Number(document.getElementById('eggsBatch').value);
  const hatchSpeed = Number(document.getElementById('hatchSpeed').value)||2.57;
  const output = document.getElementById('output');
  if(!base||!eggs){output.textContent="Please enter valid Base Rarity and Eggs per Batch.";return;}

  const totalLuck=yourLuck*eventLuck*adminLuck;
  const odds=base/totalLuck;
  const batches=odds/eggs;
  const totalTimeSec=batches*hatchSpeed;

  let displayTime;
  if(totalTimeSec<60) displayTime=totalTimeSec.toFixed(2)+' seconds';
  else if(totalTimeSec<3600) displayTime=(totalTimeSec/60).toFixed(2)+' minutes';
  else if(totalTimeSec<86400) displayTime=(totalTimeSec/3600).toFixed(2)+' hours';
  else displayTime=(totalTimeSec/86400).toFixed(2)+' days';

  output.textContent=
`Your Current Luck: ${totalLuck.toFixed(2)}x
Chances: 1/${Math.round(odds).toLocaleString()}
Time to Hatch: ~${displayTime}
Adjusted Hatch Time per Batch: ${hatchSpeed.toFixed(2)} seconds
Total Hatches Needed: ${Math.round(batches).toLocaleString()}`;
};
document.getElementById('copyBtn').onclick=()=>{navigator.clipboard.writeText(document.getElementById('output').textContent).then(()=>alert('Copied!'));};

// ================== MULTI-EGG ==================
document.getElementById('multiCalcBtn').onclick=()=>{
  const egg=document.getElementById('eggSelect').value;
  const luck=(+document.getElementById('multiYourLuck').value||1)*(+document.getElementById('multiEventLuck').value||1);
  document.getElementById('multiOutput').textContent = eggsData[egg].map(p=>`${p.name}: 1/${Math.round(p.chance/luck).toLocaleString()}`).join('\n');
};
document.getElementById('multiCopyBtn').onclick=()=>{navigator.clipboard.writeText(document.getElementById('multiOutput').textContent).then(()=>alert('Copied!'));};

// ================== SIMULATOR ==================
document.getElementById('simBtn').onclick = () => {
  const egg=document.getElementById('simEggSelect').value;
  const luck=(+document.getElementById('simYourLuck').value||1)*
             (+document.getElementById('simEventLuck').value||1)*
             (+document.getElementById('simAdminLuck').value||1);
  const batches=+document.getElementById('simBatches').value||100;
  const container=document.getElementById('simOutput'); 
  container.innerHTML='';

  const results={}; 
  eggsData[egg].forEach(p=>results[p.name]=0);
  const expected={};
  eggsData[egg].forEach(p=>expected[p.name]=Math.round(batches/(p.chance/luck)));

  for(let i=0;i<batches;i++){
    eggsData[egg].forEach(p=>{
      if(Math.random() < (1/(p.chance/luck))) results[p.name]++;
    });
  }

  eggsData[egg].forEach(p=>{
    const count=results[p.name];
    const label=document.createElement('div');
    label.textContent=`${p.name}: ${count} / Expected: ${expected[p.name]}`;
    container.appendChild(label);

    const barCont=document.createElement('div'); barCont.className='progress-container';
    const bar=document.createElement('div'); bar.className='progress-bar';
    bar.style.backgroundColor=p.chance<=100?'#ff5555':p.chance<=1000?'#55aaff':'#55ff55';
    bar.style.width=Math.max(2,(count/batches)*100)+'%';
    barCont.appendChild(bar);

    const expBar=document.createElement('div'); expBar.className='progress-bar expected';
    expBar.style.width=Math.max(2,(expected[p.name]/batches)*100)+'%';
    expBar.style.backgroundColor='#ffaa00';
    barCont.appendChild(expBar);

    container.appendChild(barCont);
  });
};
document.getElementById('simCopyBtn').onclick=()=>{navigator.clipboard.writeText(document.getElementById('simOutput').textContent).then(()=>alert('Copied!'));};
