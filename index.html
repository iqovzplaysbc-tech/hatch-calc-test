// ================== SIMULATOR WITH FAST MODE (FIXED MULTI-CLICK) ==================
let simRunId = 0; // global counter to cancel old simulations

document.getElementById('simBtn').onclick = async () => {
  simRunId++; // increment to cancel old runs
  const currentRun = simRunId;

  const egg = document.getElementById('simEggSelect').value;
  const luck = (+document.getElementById('simYourLuck').value || 1) *
               (+document.getElementById('simEventLuck').value || 1) *
               (+document.getElementById('simAdminLuck').value || 1);
  const batches = +document.getElementById('simBatches').value || 100;
  const fast = document.getElementById('fastMode').checked;
  const container = document.getElementById('simOutput'); 
  container.innerHTML = '';

  const results = {};
  eggsData[egg].forEach(p => results[p.name] = 0);
  const expected = {};
  eggsData[egg].forEach(p => expected[p.name] = Math.round(batches / (p.chance / luck)));

  const render = () => {
    if (currentRun !== simRunId) return; // stop if a new simulation started
    container.innerHTML = '';
    eggsData[egg].forEach(p => {
      const count = results[p.name];
      const label = document.createElement('div');
      label.textContent = `${p.name}: ${count} / Expected: ${expected[p.name]}`;
      container.appendChild(label);

      const barCont = document.createElement('div'); 
      barCont.className = 'progress-container';

      const bar = document.createElement('div'); 
      bar.className = 'progress-bar';
      bar.style.backgroundColor = p.chance <= 100 ? '#ff5555' : p.chance <= 1000 ? '#55aaff' : '#55ff55';
      bar.style.width = Math.max(2, (count / batches) * 100) + '%';
      barCont.appendChild(bar);

      const expBar = document.createElement('div'); 
      expBar.className = 'progress-bar expected';
      expBar.style.width = Math.max(2, (expected[p.name] / batches) * 100) + '%';
      expBar.style.backgroundColor = '#ffaa00';
      barCont.appendChild(expBar);

      container.appendChild(barCont);
    });
  };

  if (fast) {
    for (let i = 0; i < batches; i++) {
      eggsData[egg].forEach(p => { if (Math.random() < (1 / (p.chance / luck))) results[p.name]++; });
    }
    render();
  } else {
    for (let i = 0; i < batches; i++) {
      if (currentRun !== simRunId) return; // stop if a new simulation started
      eggsData[egg].forEach(p => { if (Math.random() < (1 / (p.chance / luck))) results[p.name]++; });
      render();
      await new Promise(r => setTimeout(r, 10)); // small delay for animation
    }
  }
};
